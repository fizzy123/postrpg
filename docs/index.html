<html>
  <head>
    <script>
      String.prototype.interpolate = function(params) {
        if (!params) {
          params = {}
        }
        const names = Object.keys(params);
        const vals = Object.values(params);
        return new Function(...names, `return \`${this}\`;`)(...vals);
      }

      function randomWeightedChoice(array) {
        if (array.length === 0) {
          return
        }
        // First, we loop the main dataset to count up the total weight. We're starting the counter at one because the upper boundary of Math.random() is exclusive.
        var total = 1;
        for (var i = 0; i < array.length; ++i) {
          total += array[i].weight;
        }
      
        // Total in hand, we can now pick a random value akin to our
        // random index from before.
        const threshold = Math.floor(Math.random() * total);
      
        // Now we just need to loop through the main data one more time
        // until we discover which value would live within this
        // particular threshold. We need to keep a running count of
        // weights as we go, so let's just reuse the "total" variable
        // since it was already declared.
        total = 0;
        for (var i = 0; i < array.length; ++i) {
          // Add the weight to our running total.
          total += array[i].weight;
      
          // If this value falls within the threshold, we're done!
          if (total >= threshold) {
            return array[i];
          }
        }
      }

      window.addEventListener('load', function () {
        var situations;
        var elements;
        const queryElements = function(tags) {
          console.log(1)
          var matches = []
          for (element of elements) {
            match = true
            for (tag of tags) {
               if (element.tags.indexOf(tag)) {
                 match - false 
                 break
               }
            }
            if (match) {
              matches.push(element)
            }
          }
          choice = randomWeightedChoice(elements)
          return `<a href="./${choice.id}_page.html">${choice.name}</a>`
        }
        var generateSituation = async function() {
          encounters = await (await fetch("/gen/encounters.json")).json()
          elements = await (await fetch("/gen/elements.json")).json()
          var encounter = encounters[Math.floor(encounters.length * Math.random())] 
          console.log(encounter.description)
          console.log(queryElements)
          var encounterHTML = encounter.description.interpolate({})
          console.log(encounterHTML)
          document.getElementById("encounter").html = encounterHTML

          state = window.localStorage.state
          // State Schema
          /*
          {
            quests: [
              {
                name:1,
                probability: 0.1,
                effect: ""
              },
              {
                name:"Player 2 Quest",
                probability: 0.1,
                effect: ""
              },
              {
                name:"Stolen good",
                probability: 0.1,
                effect: "The group that you stole this good from finds you."
              },
            ]
            tags: []
          }
          */
        }
        generateSituation()
      })
    </script>
  </head>
  <body style="background-color: black;color: white;text-align: center;font-family: Arial;">
    <div>
      You encounter
    </div>
    <div id="encounter">
    </div>
  </body>
</html>
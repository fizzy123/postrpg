<html>
  <head>
    <script>
      String.prototype.interpolate = function(params) {
        if (!params) {
          params = {}
        }
        const names = Object.keys(params);
        const vals = Object.values(params);
        return new Function(...names, `return \`${this}\`;`)(...vals);
      }

      function randomWeightedChoice(array) {
        if (array.length === 0) {
          return
        }
        // First, we loop the main dataset to count up the total weight. We're starting the counter at one because the upper boundary of Math.random() is exclusive.
        var total = 1;
        for (var i = 0; i < array.length; ++i) {
          total += array[i].weight;
        }
      
        // Total in hand, we can now pick a random value akin to our
        // random index from before.
        const threshold = Math.floor(Math.random() * total);
      
        // Now we just need to loop through the main data one more time
        // until we discover which value would live within this
        // particular threshold. We need to keep a running count of
        // weights as we go, so let's just reuse the "total" variable
        // since it was already declared.
        total = 0;
        for (var i = 0; i < array.length; ++i) {
          // Add the weight to our running total.
          total += array[i].weight;
      
          // If this value falls within the threshold, we're done!
          if (total >= threshold) {
            return array[i];
          }
        }
      }

      const triggerCount = 4
      window.addEventListener('load', function () {
        var situations;
        var elements;
        const queryElements = function(tags) {
          var matches = []
          for (element of elements) {
            match = true
            for (tag of tags) {
               if (element.tags.indexOf(tag) === -1) {
                 match = false 
                 break
               }
            }
            if (match) {
              if (element) {
                matches.push(element)
              }
            }
          }
          if (matches.length === 0) {
            throw Error(`No matches found for these tags: ${tags}`)
          }
          choice = randomWeightedChoice(matches)
          let description = choice.description
          if (description.length === 0) {
            description = "No description provided"
          }
          document.getElementById("description").innerHTML = document.getElementById("description").innerHTML + `<div><b>${choice.name}</b> ${description}</div>`
          return `<a href="./gen/${choice.id}_page.html">${choice.name}</a>`
        }
        var generateSituation = async function() {
          encounters = await (await fetch("/gen/encounters.json")).json()
          elements = await (await fetch("/gen/elements.json")).json()
          var encounter = encounters[Math.floor(encounters.length * Math.random())] 
          var encounterHTML = encounter.description.interpolate({ queryElements: queryElements })
          document.getElementById("encounter").innerHTML = encounterHTML

          const triggerRoll = Math.random()
          if (triggerRoll < 0.6) {
            const trigger = Math.ceil(Math.random() * triggerCount)
            document.getElementById("triggers").innerHTML = `A clue for questline ${trigger} can be found here.`
          } else if (triggerRoll > 0.3) {
            const trigger = Math.ceil(Math.random() * triggerCount)
            document.getElementById("triggers").innerHTML = `Questline ${trigger} can progress here.`
          } else if (triggerRoll > 0.1) {
            const trigger1 = Math.ceil(Math.random() * triggerCount)
            const trigger2 = Math.ceil(Math.random() * triggerCount)
            document.getElementById("triggers").innerHTML = `Questlines ${trigger1} and ${trigger2} will both progress here.`
          }

          state = window.localStorage.state
          // State Schema
          /*
          {
            quests: [
              {
                name:1,
                probability: 0.1,
                effect: ""
              },
              {
                name:"Player 2 Quest",
                probability: 0.1,
                effect: ""
              },
              {
                name:"Stolen good",
                probability: 0.1,
                effect: "The group that you stole this good from finds you."
              },
            ]
            tags: []
          }
          */
        }
        generateSituation()
      })
    </script>
  </head>
  <body style="background-color: black;color: white;text-align: center;font-family: Arial;">
    <div>
    <div id="encounter" style="font-size: 48px;font-weight: bold;"></div>
    <div id="triggers"></div>
    </div>
    <div id="description"></div>
  </body>
</html>
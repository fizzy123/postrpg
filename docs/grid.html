<html>
  <head>
    <style>
      td {
        background: #222;
      }
      .contentTitle {
        background: #111;
        margin: 10px 20px;
        padding: 10px;
      }
      .selected {
        border: 1px white solid;
      }
      .content {
        padding: 20px;
      }
      .contentName {
        font-size: 24px;
      }
      input,textarea {
        width: 100%;
        background-color: black;
        color: white;
      }
      table {
        margin: auto;
      }
      .generate {
        margin: auto;
      }
      .highlight {
        border: 1px white solid;
      }
    </style>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      let personToPersonRel = []
      let personToItemRel = []
      let personToFeatureRel = []
      let featureToItemRel = []
      let emotions = []
      let archetypes = []
      let features = []
      let events = []
      let reactions = []
      let entities = []
      let items = []
      let scenario = [
          [],
          [],
          [],
          [],
          [],
        ]
      let idCounter = 0
      let establishCorpus = async () => {
        // parse corpus sheet

        let sheetIndex = 7
        let response = await axios.get(`https://spreadsheets.google.com/feeds/list/1NXj5-cpQ7Cnn3fB-lKoRFCjJ0GTC34AULyHQF4zYek0/${sheetIndex}/public/values?alt=json`);
        for (const row of response.data.feed.entry) {
          if (row["gsx$persontopersonrel"]["$t"]) {
            personToPersonRel.push(row["gsx$persontopersonrel"]["$t"])
          }
          if (row["gsx$persontoitemrel"]["$t"]) {
            personToItemRel.push(row["gsx$persontoitemrel"]["$t"])
          }
          if (row["gsx$persontofeaturerel"]["$t"]) {
            personToFeatureRel.push(row["gsx$persontofeaturerel"]["$t"])
          }
          if (row["gsx$featuretoitemrel"]["$t"]) {
            featureToItemRel.push(row["gsx$featuretoitemrel"]["$t"])
          }
          if (row["gsx$emotions"]["$t"]) {
            emotions.push(row["gsx$emotions"]["$t"])
          }
          if (row["gsx$archetypes"]["$t"]) {
            archetypes.push(row["gsx$archetypes"]["$t"])
          }
          if (row["gsx$features"]["$t"]) {
            features.push({
              id: idCounter++,
              name: row["gsx$features"]["$t"],
              description: "",
              type:"feature",
            })
          }
          if (row["gsx$events"]["$t"]) {
            events.push(row["gsx$events"]["$t"])
          }
          if (row["gsx$reactions"]["$t"]) {
            reactions.push(row["gsx$reactions"]["$t"])
          }
        }
        // parse entity sheet
        sheetIndex = 8
        response = await axios.get(`https://spreadsheets.google.com/feeds/list/1NXj5-cpQ7Cnn3fB-lKoRFCjJ0GTC34AULyHQF4zYek0/${sheetIndex}/public/values?alt=json`);
        for (const row of response.data.feed.entry) {
          entities.push({
            id: idCounter++,
            name: row["gsx$name"]["$t"],
            description: row["gsx$description"]["$t"],
            type: "entity",
            emotion: emotions[Math.floor(Math.random() * emotions.length)],
          })
        }
        // parse items sheet
        sheetIndex = 9
        response = await axios.get(`https://spreadsheets.google.com/feeds/list/1NXj5-cpQ7Cnn3fB-lKoRFCjJ0GTC34AULyHQF4zYek0/${sheetIndex}/public/values?alt=json`);
        for (const row of response.data.feed.entry) {
          items.push({
            id: idCounter++,
            name: row["gsx$name"]["$t"],
            description: row["gsx$description"]["$t"],
            type: "item",
          })
        }
      }
      function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex;
      
        // While there remain elements to shuffle...
        while (0 !== currentIndex) {
      
          // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;
      
          // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }
      
        return array;
      }
			const rotate = function(nums, k) {
				if(nums.length > k){
					nums.unshift( ...nums.splice(-k))
				} else {
					let i = 0
					while(i < k){
						nums.unshift(nums.splice(-1))
						i++
					}
				}
				return nums

			};
      const generateMap = () => {
        scenario = [
          [],
          [],
          [],
          [],
          [],
        ]
        // select which magic items will exist
        items = shuffle(items)
        const itemSelection = items.slice(0,4)

        // generate characters that should exist
        const characters = []
        for (let index = 0; index < 3; index++) {
          characters.push({
            id: idCounter++,
            name: faker.name.findName(),
            description: `Archetypes: ${archetypes[Math.floor(Math.random() * archetypes.length)]}, ${archetypes[Math.floor(Math.random() * archetypes.length)]}\n`,
            type: "character",
          })
        }

        // choose which entities should be on the map
        entities = shuffle(entities)
        const entitySelection = entities.slice(0,5)

        // choose which features should be on a map
        features = shuffle(features)
        const featureSelection = features.slice(0,5)

        const subjects = [...characters];
        const predicates = rotate([...characters], 1);
        for (let i = 0; i < subjects.length; i++) {
          const subject = subjects[i]
          const predicate = predicates[i]
          if (subject.name === predicate.name) {
            continue
          }
          const event = events[Math.floor(Math.random() * events.length)]
          subject.description = `${subject.description}\n${subject.name} ${event} ${predicate.name}\nThey left the encounter feeling ${emotions[Math.floor(Math.random() * emotions.length)]}\n`
          predicate.description = `${predicate.description}\n${subject.name} ${event} ${predicate.name}\nThey left the encounter feeling ${emotions[Math.floor(Math.random() * emotions.length)]}\n`
        }

        for (let i = 0; i < characters.length; i++) {
          characters[i].description = `${characters[i].description}\nAs a result, they now ${reactions[Math.floor(Math.random() * reactions.length)]} someone/something.`
        }

        // assign characters, entities, features and items to cells
        const content = shuffle(characters).concat(shuffle(entitySelection)).concat(shuffle(featureSelection)).concat(shuffle(itemSelection))
        let positions = [0, 1, 2, 3, 4]
        positions = shuffle(positions).concat(shuffle(positions))
        for (let i = 0; i < content.length; i++) {
          scenario[positions[i]].push(content[i])
        }
        printScenario(scenario)
      }

      const printScenario = async (scenario) => {
        scenarioText = ""
        for (let i = 0; i < scenario.length; i++) {
          scenarioText += `====Encounter ${i}====\n`
          for (let content of scenario[i]) {
            scenarioText += `${content.name.toUpperCase()}\n`
            scenarioText += `${content.description}\n`
            scenarioText += "\n"
          }
          scenarioText += "\n"
        }
        window.localStorage.scenario = scenarioText
        $(".scenario").text(scenarioText);
      }

      const init = async () => {
        $(".generate-button").click(generateMap)
        await establishCorpus()
        if (!window.localStorage.scenario) {
          generateMap()
        } else {
          scenarioText = JSON.parse(window.localStorage.scenario)
          $(".scenario").text(scenarioText);
        }
      }
      $( document ).ready(init)
    </script>
  </head>
  <body style="background-color:black;color:white;text-align: center;">
    <textarea class="scenario"></textarea>
    <button class="generate-button">Generate</button>
  </body>
</html>